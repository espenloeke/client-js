window.FHIR=function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=3)}([function(e,t,r){const n=r(1),{isBrowser:o,request:s,getPath:i,randomString:a,btoa:c}=r(2),u="SMART_KEY";function h(e="/"){const t=String(e).replace(/\/*$/,"/")+"metadata";return s(t).catch(e=>{throw new Error(`Failed to fetch the conformance statement from "${t}". ${e}`)})}function l(e="/"){const t=String(e).replace(/\/*$/,"/")+".well-known/smart-configuration";return s(t).catch(e=>{throw new Error(`Failed to fetch the well-known json "${t}". ${e.message}`)})}function f(e="/"){return l(e).then(e=>{if(!e.authorization_endpoint||!e.token_endpoint)throw new Error("Invalid wellKnownJson");return{registrationUri:e.registration_endpoint||"",authorizeUri:e.authorization_endpoint,tokenUri:e.token_endpoint}}).catch(()=>h(e).then(e=>{const t=(i(e||{},"rest.0.security.extension")||[]).filter(e=>"http://fhir-registry.smarthealthit.org/StructureDefinition/oauth-uris"===e.url).map(e=>e.extension)[0],r={registrationUri:"",authorizeUri:"",tokenUri:""};return t&&t.forEach(e=>{"register"===e.url&&(r.registrationUri=e.valueUri),"authorize"===e.url&&(r.authorizeUri=e.valueUri),"token"===e.url&&(r.tokenUri=e.valueUri)}),r}))}async function p(e,t={},r=!1){let{iss:n,launch:o,fhirServiceUrl:s,redirect_uri:i,redirectUri:c,scope:h="",clientSecret:l,fakeTokenResponse:p,patientId:d,encounterId:g,client_id:w,clientId:m}=t;const y=e.getUrl(),U=e.getStorage();n=y.searchParams.get("iss")||n,s=y.searchParams.get("fhirServiceUrl")||s,o=y.searchParams.get("launch")||o,m||(m=w),c||(c=i),c=c?e.relative(c):e.relative(".");const k=String(n||s||"");if(!k)throw new Error("No server url found. It must be specified as `iss` or as `fhirServiceUrl` parameter");o&&!h.match(/launch/)&&(h+=" launch"),await U.unset(u);const S=a(16),b={clientId:m,scope:h,redirectUri:c,serverUrl:k,clientSecret:l,tokenResponse:{},key:S};p&&Object.assign(b.tokenResponse,p),d&&Object.assign(b.tokenResponse,{patient:d}),g&&Object.assign(b.tokenResponse,{encounter:g});let _=c+"?state="+encodeURIComponent(S);if(s&&!n)return await U.set(S,b),r?_:await e.redirect(_);const v=await f(k);if(Object.assign(b,v),await U.set(S,b),!b.authorizeUri)return r?_:await e.redirect(_);const x=["response_type=code","client_id="+encodeURIComponent(m),"scope="+encodeURIComponent(h),"redirect_uri="+encodeURIComponent(c),"aud="+encodeURIComponent(k),"state="+encodeURIComponent(S)];return o&&x.push("launch="+encodeURIComponent(o)),_=b.authorizeUri+"?"+x.join("&"),r?_:await e.redirect(_)}async function d(e){const t=e.getUrl(),r=e.getStorage(),a=t.searchParams;let c=a.get("state");const h=a.get("code"),l=a.get("error"),f=a.get("error_description");if(c||(c=await r.get(u)),l||f){let e=[l,f].filter(Boolean).join(": ");throw new Error(e)}if(!c)throw new Error("No 'state' parameter found. Please (re)launch the app.");let p=await r.get(c);const d=!o()||i(e,"options.fullSessionStorageSupport"),w=a.has("state");if(o()&&i(e,"options.replaceBrowserHistory")&&(h||w)&&(h&&a.delete("code"),w&&d&&a.delete("state"),window.history.replaceState&&window.history.replaceState({},"",t.href)),!p)throw new Error("No state found! Please (re)launch the app.");if(h){const e=await g(h,p);let t=await s(p.tokenUri,e);if(!t.access_token)throw new Error("Failed to obtain access token.");p={...p,tokenResponse:t},await r.set(c,p),d&&await r.set(u,c)}return new n(e,p)}function g(e,t){const{redirectUri:r,clientSecret:n,tokenUri:o,clientId:s}=t;if(!r)throw new Error("Missing state.redirectUri");if(!o)throw new Error("Missing state.tokenUri");if(!s)throw new Error("Missing state.clientId");const i={method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:`code=${e}&grant_type=authorization_code&redirect_uri=${encodeURIComponent(r)}`};return n?i.headers.Authorization="Basic "+c(s+":"+n):i.body+=`&client_id=${encodeURIComponent(s)}`,i}e.exports={fetchConformanceStatement:h,fetchWellKnownJson:l,getSecurityExtensions:f,buildTokenRequest:g,authorize:p,completeAuth:d,ready:async function(e,t,r){let n=d(e);return t&&(n=n.then(t)),r&&(n=n.catch(r)),n},init:async function(e,t){const r=e.getUrl(),o=r.searchParams.get("code"),s=r.searchParams.get("state");if(o&&s)return d(e);const i=e.getStorage(),a=s||await i.get(u),c=await i.get(a);return c?Promise.resolve(new n(e,c)):p(e,t).then(()=>new Promise(()=>{}))},KEY:u}},function(e,t,r){const{absolute:n,getPath:o,setPath:s,jwtDecode:i,makeArray:a,request:c,btoa:u,byCode:h,byCodes:l,units:f}=r(2),p=r(9);function d(e,t,r,n){let i=a(t.resolveReferences).filter(Boolean).map(e=>String(e).trim()).filter(Boolean);if(!(i=i.filter((e,t)=>{return!(i.indexOf(e,t+1)>-1)})).length)return Promise.resolve();const c={};i.forEach(e=>{const t=e.split(".").length;c[t]||(c[t]=[]),c[t].push(e)});let u=Promise.resolve();return Object.keys(c).sort().forEach(i=>{const h=c[i];u=u.then(()=>Promise.all(h.map(i=>(function(e,t,r,n,i){const c=o(e,t);if(c){const o=Array.isArray(c);return Promise.all(a(c).map((a,c)=>{const u=a.reference;if(u)return function(e,t,r){let n=t[e];return n||(t[e]=r.request(e).then(r=>(t[e]=r,r),r=>{throw delete t[e],r}),t[e])}(u,n,i).then(n=>{r&&s(e,o?`${t}.${c}`:t,n)}).catch(()=>{})}))}})(e,i,t.graph,r,n))))}),u}e.exports=class{constructor(e,t){const r="string"==typeof t?{serverUrl:t}:t;if(!r.serverUrl||!r.serverUrl.match(/https?:\/\/.+/))throw new Error('A "serverUrl" option is required and must begin with "http(s)"');this.state=r,this.environment=e;const n=this;this.patient={get id(){return n.getPatientId()},read:()=>{const e=this.patient.id;return e?this.request(`Patient/${e}`):Promise.reject(new Error("Patient is not available"))}},this.encounter={get id(){return n.getEncounterId()},read:()=>{const e=this.encounter.id;return e?this.request(`Encounter/${e}`):Promise.reject(new Error("Encounter is not available"))}},this.user={get fhirUser(){return n.getFhirUser()},get id(){return n.getUserId()},get resourceType(){return n.getUserType()},read:()=>{const e=this.user.fhirUser;return e?this.request(e):Promise.reject(new Error("User is not available"))}},e.fhir&&this.connect(e.fhir)}connect(e){if("function"==typeof e){const t={baseUrl:this.state.serverUrl.replace(/\/$/,"")},r=o(this,"state.tokenResponse.access_token");if(r)t.auth={token:r};else{const{username:e,password:r}=this.state;e&&r&&(t.auth={user:e,pass:r})}this.api=e(t);const n=o(this,"state.tokenResponse.patient");n&&(this.patient.api=e({...t,patient:n}))}}getPatientId(){const e=this.state.tokenResponse;return e&&e.patient?e.patient:null}getEncounterId(){const e=this.state.tokenResponse;return e&&e.encounter?e.encounter:null}getIdToken(){const e=this.state.tokenResponse;if(e){const t=e.id_token;return this.state.scope,t?i(t):null}return null}getFhirUser(){const e=this.getIdToken();return e?e.profile:null}getUserId(){const e=this.getFhirUser();return e?e.split("/")[1]:null}getUserType(){const e=this.getFhirUser();return e?e.split("/")[0]:null}getAuthorizationHeader(){const e=o(this,"state.tokenResponse.access_token");if(e)return"Bearer "+e;const{username:t,password:r}=this.state;return t&&r?"Basic "+u(t+":"+r):null}async _clearState(){const{KEY:e}=r(0),t=this.environment.getStorage(),n=await t.get(e);n&&await t.unset(n),await t.unset(e),this.state.tokenResponse={}}async request(e,t={},r={}){if(!e)throw new Error("request requires an url or request options as argument");let s;"string"==typeof e||e instanceof URL?(s=String(e),e={}):s=String(e.url),s=n(s,this.state.serverUrl);const i=this.getAuthorizationHeader();i&&(e.headers={...e.headers,Authorization:i}),t.graph=!1!==t.graph,t.flat=!!t.flat,t.pageLimit||0===t.pageLimit||(t.pageLimit=1);const u="function"==typeof t.onPage;return c(s,e).catch(n=>{if(401==n.status&&!1!==t.useRefreshToken&&o(this,"state.tokenResponse.refresh_token"))return this.refresh().then(()=>this.request({...e,url:s},t,r));throw n}).catch(async e=>{if(401==e.status){if(!o(this,"state.tokenResponse.access_token"))throw new Error("This app cannot be accessed directly. Please launch it as SMART app!");if(!1===t.useRefreshToken)throw await this._clearState(),new Error(p.expired);throw await this._clearState(),new Error(p.expired)}throw e}).then(e=>e?"string"==typeof e?e:"object"==typeof e&&e instanceof Response?e:(async e=>(e&&("Bundle"==e.resourceType?await Promise.all((e.entry||[]).map(e=>d(e.resource,t,r,this))):await d(e,t,r,this)),e))(e).then(async e=>{if(e&&"Bundle"==e.resourceType){const n=e.link||[];if(t.flat&&(e=(e.entry||[]).map(e=>e.resource)),u&&await t.onPage(e,{...r}),--t.pageLimit){const o=n.find(e=>"next"==e.relation);if(e=a(e),o&&o.url){const n=await this.request(o.url,t,r);return u?null:t.resolveReferences&&t.resolveReferences.length?(Object.assign(r,n.references),e.concat(a(n.data||n))):e.concat(a(n))}}}return e}).then(e=>{if(t.graph)r={};else if(!u&&t.resolveReferences.length)return{data:e,references:r};return e}):e)}refresh(){const e=o(this,"state.tokenResponse.refresh_token");if(!e)throw new Error("Unable to refresh. No refresh_token found.");const t=this.state.tokenUri;if(!t)throw new Error("Unable to refresh. No tokenUri found.");if(-1==(o(this,"state.tokenResponse.scope")||"").indexOf("offline_access"))throw new Error("Unable to refresh. No offline_access scope found.");return this._refreshTask||(this._refreshTask=c(t,{mode:"cors",method:"POST",headers:{"content-type":"application/x-www-form-urlencoded"},body:`grant_type=refresh_token&refresh_token=${encodeURIComponent(e)}`}).then(e=>{if(!e.access_token)throw new Error("No access token received");return e}).then(e=>(Object.assign(this.state.tokenResponse,e),this.state)).catch(e=>{throw delete this.state.tokenResponse.refresh_token,e}).finally(()=>{this._refreshTask=null,this.environment.getStorage().set(this.state.key,this.state)})),this._refreshTask}byCode(e,t){return h(e,t)}byCodes(e,t){return l(e,t)}get units(){return f}getPath(e,t){return o(e,t)}}},function(e,t,r){(function(t){const n=r(8);function o(){return"object"==typeof window}async function s(e){if(!e.ok)throw await a(e);return e}function i(e){return e.text().then(e=>e.length?JSON.parse(e):"")}async function a(e){let t=`${e.status} ${e.statusText}\nURL: ${e.url}`;try{const r=e.headers.get("Content-Type")||"text/plain";if(r.match(/\bjson\b/i)){const r=await e.json();r.error?(t+="\n"+r.error,r.error_description&&(t+=": "+r.error_description)):t+="\n\n"+JSON.stringify(r,null,4)}if(r.match(/^text\//i)){const r=await e.text();r&&(t+="\n\n"+r)}}catch(e){}throw new n(t,e.status,e.statusText)}function c(e){return Array.isArray(e)?e:[e]}function u(e){return o()?window.atob(e):t.Buffer.from(e,"base64").toString("ascii")}function h(e,t){const r={};function n(e,t){e&&Array.isArray(e.coding)&&e.coding.forEach(({code:e})=>{r[e]=r[e]||[],r[e].push(t)})}return c(e).forEach(e=>{"Observation"===e.resourceType&&e[t]&&(Array.isArray(e[t])?e[t].forEach(t=>n(t,e)):n(e[t],e))}),r}function l({value:e,code:t}){if("number"!=typeof e)throw new Error("Found a non-numerical unit: "+e+" "+t)}const f={cm({code:e,value:t}){if(l({code:e,value:t}),"cm"==e)return t;if("m"==e)return 100*t;if("in"==e)return 2.54*t;if("[in_us]"==e)return 2.54*t;if("[in_i]"==e)return 2.54*t;if("ft"==e)return 30.48*t;if("[ft_us]"==e)return 30.48*t;throw new Error("Unrecognized length unit: "+e)},kg({code:e,value:t}){if(l({code:e,value:t}),"kg"==e)return t;if("g"==e)return t/1e3;if(e.match(/lb/))return t/2.20462;if(e.match(/oz/))return t/35.274;throw new Error("Unrecognized weight unit: "+e)},any:e=>(l(e),e.value)};e.exports={stripTrailingSlash:function(e){return String(e||"").replace(/\/+$/,"")},absolute:function(e,t){return e.match(/^http/)?e:e.match(/^urn/)?e:t.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,"")},getPath:function(e,t=""){return(t=t.trim())?t.split(".").reduce((e,t)=>e?e[t]:void 0,e):e},setPath:function(e,t,r){return t.trim().split(".").reduce((e,t,n,o)=>{if(!e||n!==o.length-1)return e?e[t]:void 0;e[t]=r},e),e},makeArray:c,randomString:function(e=8,t=null){const r=[],n=(t=t||"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789").length;for(;e--;)r.push(t.charAt(Math.floor(Math.random()*n)));return r.join("")},isBrowser:o,checkResponse:s,responseToJSON:i,humanizeError:a,jwtDecode:function(e){const t=e.split(".")[1];return JSON.parse(u(t))},request:function(e,t={}){return fetch(e,{mode:"cors",...t,headers:{accept:"application/json",...t.headers}}).then(s).then(e=>{const t=e.headers.get("Content-Type")+"";return t.match(/\bjson\b/i)?i(e):t.match(/^text\//i)?e.text():e})},atob:u,btoa:function(e){return o()?window.btoa(e):t.Buffer.from(e).toString("base64")},byCode:h,byCodes:function(e,t){const r=h(e,t);return(...e)=>e.filter(e=>e+""in r).reduce((e,t)=>[...e,...r[t+""]],[])},units:f}}).call(this,r(7))},function(e,t,r){const n=r(4),{ready:o,authorize:s,init:i,client:a,options:c}=n();e.exports={client:a,oauth2:{settings:c,ready:o,authorize:s,init:i}}},function(e,t,r){const n=r(5),o=r(6);class s extends o{get fhir(){return"function"==typeof fhir?fhir:null}getUrl(){return this._url||(this._url=new URL(location+"")),this._url}redirect(e){location.href=e}getStorage(){return this._storage||(this._storage=new n),this._storage}static smart(e){return new s(e).getSmartApi()}}e.exports=s.smart,e.exports.Adapter=s},function(e,t){e.exports=class{async get(e){const t=sessionStorage[e];return t?JSON.parse(t):null}async set(e,t){return sessionStorage[e]=JSON.stringify(t),t}async unset(e){return e in sessionStorage&&(delete sessionStorage[e],!0)}}},function(e,t,r){const n=r(0),o=r(1);e.exports=class{constructor(e={}){this.options={replaceBrowserHistory:!0,fullSessionStorageSupport:!0,...e}}getUrl(){return new URL("")}getStorage(){}relative(e){return new URL(e,this.getUrl().href).href}getSmartApi(){return{ready:(...e)=>n.ready(this,...e),authorize:e=>n.authorize(this,e),init:(...e)=>n.init(this,...e),client:e=>new o(this,e),options:this.options}}}},function(e,t){var r;r=function(){return this}();try{r=r||new Function("return this")()}catch(e){"object"==typeof window&&(r=window)}e.exports=r},function(e,t){class r extends Error{constructor(e,t,r){super(e),this.message=e,this.name="HttpError",this.statusCode=t,this.status=t,this.statusText=r}toJSON(){return{name:this.name,statusCode:this.statusCode,status:this.status,statusText:this.statusText,message:this.message}}static create(e){var t=0,n="Error",o="Unknown error";return e&&("object"==typeof e?e instanceof Error?o=e.message:e.error&&(t=e.error.status||0,n=e.error.statusText||"Error",e.error.responseText&&(o=e.error.responseText)):"string"==typeof e&&(o=e)),new r(o,t,n)}}e.exports=r},function(e,t){e.exports={expired:"Session expired! Please re-launch the app",noScopeForId:"Trying to get the ID of the selected %s. Please add 'launch' or 'launch/%s' to the requested scopes and try again.",noIfNoAuth:"You are trying to get %s but the app is not authorized yet.",noFreeContext:"Please don't use open fhir servers if you need to access launch context items like the %S."}}]);
//# sourceMappingURL=fhir-client.pure.min.js.map